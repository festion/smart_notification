<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Notification Router</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@6.5.95/css/materialdesignicons.min.css">
    <style>
        /* Home Assistant compatibility styles */
        :root {
            --ha-card-border-radius: 4px;
            --ha-card-box-shadow: 0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12),0 3px 1px -2px rgba(0,0,0,.2);
        }
        
        /* Display fix for object Object issues */
        .audience-entry select option[value="[object Object]"] {
            display: none;
        }
        
        /* Make cards more HA styled */
        .config-card, .status-card, .test-card {
            border-radius: var(--ha-card-border-radius, 4px);
            box-shadow: var(--ha-card-box-shadow, 0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12),0 3px 1px -2px rgba(0,0,0,.2));
            background: var(--ha-card-background, var(--card-color));
        }
        
        /* Improve form elements */
        input[type="text"], textarea, select {
            border-radius: 4px;
            border: 1px solid var(--ha-form-border-color, #ddd);
            padding: 8px 12px;
            background: var(--ha-form-bg-color, white);
            color: var(--ha-form-text-color, #212121);
        }
        
        /* Improve button styles */
        button {
            background-color: var(--ha-button-primary-color, var(--primary-color));
            color: var(--ha-button-text-color, white);
            font-weight: 500;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="mdi mdi-bell-ring"></i> Smart Notification Router</h1>
        </header>
        
        <section class="status-section">
            <div class="status-card">
                <h3>Status</h3>
                <p><i class="mdi mdi-circle" id="status-indicator"></i> <span id="status-text">Checking...</span></p>
                <p>Deduplication Time: <span id="dedup-time">{{ deduplication_ttl }}</span> seconds</p>
                <p>Active Messages: <span id="active-messages">0</span></p>
            </div>
        </section>
        
        <form action="/config" method="POST" class="config-form">
            <section class="config-section">
                <h2>Notification Configuration</h2>
                
                <div class="config-card">
                    <h3>Severity Levels</h3>
                    <p class="hint">Comma-separated list of severity levels in ascending order (least severe to most severe)</p>
                    <input type="text" name="severity_levels" id="severity-levels" 
                           value="{{ ','.join(config.severity_levels) }}" 
                           placeholder="low, medium, high, emergency">
                </div>
                
                <div class="config-card">
                    <h3>Audience Configuration</h3>
                    <div id="audiences-container">
                        {% for name, audience in config.audiences.items() %}
                        <div class="audience-entry">
                            <input type="text" name="audience_name" value="{{ name }}" placeholder="Audience Name" class="audience-name">
                            <select name="audience_severity" class="audience-severity">
                                {% for severity in config.severity_levels %}
                                <option value="{{ severity }}" {% if severity == audience.min_severity %}selected{% endif %}>{{ severity }}</option>
                                {% endfor %}
                            </select>
                            <input type="text" name="audience_services" value="{{ ','.join(audience.services) }}" placeholder="notify.service1, notify.service2" class="audience-services">
                            <button type="button" class="remove-btn"><i class="mdi mdi-delete"></i></button>
                        </div>
                        {% endfor %}
                    </div>
                    <button type="button" id="add-audience" class="add-btn"><i class="mdi mdi-plus"></i> Add Audience</button>
                </div>
            </section>
            
            <div class="actions">
                <button type="submit" class="save-btn"><i class="mdi mdi-content-save"></i> Save Configuration</button>
            </div>
        </form>
        
        <section class="test-section">
            <h2>Test Notification</h2>
            <div class="test-card">
                <div class="form-group">
                    <label for="test-title">Title</label>
                    <input type="text" id="test-title" placeholder="Notification Title">
                </div>
                
                <div class="form-group">
                    <label for="test-message">Message</label>
                    <textarea id="test-message" placeholder="Notification Message"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="test-severity">Severity</label>
                    <select id="test-severity">
                        {% for severity in config.severity_levels %}
                        <option value="{{ severity }}">{{ severity }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Audience</label>
                    <div id="test-audience-options">
                        {% for name, audience in config.audiences.items() %}
                        <label class="checkbox-container">
                            <input type="checkbox" name="test_audience" value="{{ name }}">
                            <span class="checkbox-label">{{ name }}</span>
                        </label>
                        {% endfor %}
                    </div>
                </div>
                
                <button id="send-test" class="test-btn"><i class="mdi mdi-send"></i> Send Test Notification</button>
                <div id="test-result" class="hidden"></div>
            </div>
        </section>
    </div>
    <script>
        console.log('HTML template loaded successfully');
    </script>
    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
    <script>
        // Fallback script to ensure UI initialization
        window.addEventListener('load', function() {
            console.log('Window fully loaded - checking if UI was initialized');
            
            // Add audience button
            const addButton = document.getElementById('add-audience');
            if (addButton && !addButton._hasClickListener) {
                console.log('Reinitializing add audience button');
                addButton._hasClickListener = true;
                addButton.addEventListener('click', function() {
                    console.log('Add audience button clicked');
                    const container = document.getElementById('audiences-container');
                    const severityLevels = document.getElementById('severity-levels').value
                        .split(',')
                        .map(level => level.trim())
                        .filter(level => level !== '');
                        
                    // Create a simple audience entry
                    const entry = document.createElement('div');
                    entry.className = 'audience-entry';
                    entry.innerHTML = `
                        <input type="text" name="audience_name" class="audience-name" placeholder="Audience Name" value="">
                        <select name="audience_severity" class="audience-severity">
                            ${severityLevels.map(level => `<option value="${level}">${level}</option>`).join('')}
                        </select>
                        <input type="text" name="audience_services" class="audience-services" placeholder="notify.service1, notify.service2" value="">
                        <button type="button" class="remove-btn"><i class="mdi mdi-delete"></i></button>
                    `;
                    
                    container.appendChild(entry);
                });
            }
            
            // Send test button
            const sendButton = document.getElementById('send-test');
            if (sendButton && !sendButton._hasClickListener) {
                console.log('Reinitializing send test button');
                sendButton._hasClickListener = true;
                sendButton.addEventListener('click', function() {
                    console.log('Send test button clicked');
                    
                    const title = document.getElementById('test-title').value;
                    const message = document.getElementById('test-message').value;
                    const severity = document.getElementById('test-severity').value;
                    
                    const audienceChecks = document.querySelectorAll('input[name="test_audience"]:checked');
                    const audience = Array.from(audienceChecks).map(check => check.value);
                    
                    if (!title || !message) {
                        showTestResult('Please provide both title and message', false);
                        return;
                    }
                    
                    if (audience.length === 0) {
                        showTestResult('Please select at least one audience', false);
                        return;
                    }
                    
                    // Define showTestResult if it's not available
                    function showTestResult(message, success) {
                        const resultDiv = document.getElementById('test-result');
                        if (!resultDiv) return;
                        
                        resultDiv.textContent = message;
                        resultDiv.className = success ? 'success-message' : 'error-message';
                        resultDiv.classList.remove('hidden');
                        
                        setTimeout(() => {
                            resultDiv.classList.add('hidden');
                        }, 5000);
                    }
                    
                    // Send the actual notification
                    const payload = { title, message, severity, audience };
                    
                    fetch('/notify', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'ok') {
                            showTestResult('Notification sent successfully!', true);
                        } else if (data.status === 'duplicate') {
                            showTestResult('Duplicate notification: ' + data.message, false);
                        } else {
                            showTestResult('Error: ' + data.message, false);
                        }
                    })
                    .catch(error => {
                        console.error('Failed to send test notification:', error);
                        showTestResult('Failed to send notification: ' + error.message, false);
                    });
                });
            }
        });
    </script>
</body>
</html>